# usage:
#
#- template: dockle-container.yml
#  parameters:
#    image: 'my-image-name'
#    failLevel: 'fatal'


parameters:
  - name: image
  - name: failLevel
    default: 'fatal' # allowed values are 'info', 'warn', 'fatal'

steps:
- script: |
    VERSION=$(
    curl --silent "https://api.github.com/repos/goodwithtech/dockle/releases/latest" | \
    grep '"tag_name":' | \
    sed -E 's/.*"v([^"]+)".*/\1/' \
    ) && curl -L -o dockle.tar.gz https://github.com/goodwithtech/dockle/releases/download/v${VERSION}/dockle_${VERSION}_Linux-64bit.tar.gz &&  \
    tar zxvf dockle.tar.gz
    ./dockle -v
  displayName: 'Download and install Dockle'

- task: CmdLine@2
  displayName: "Run Dockle scan"
  inputs:
    script: |
      # Print report
      ./dockle --exit-code 0 ${{ parameters.image }}
      # Fail on critical checkpoints
      ./dockle --exit-code 1 --exit-level ${{ parameters.failLevel }} ${{ parameters.image }} >> /dev/null
      
      
